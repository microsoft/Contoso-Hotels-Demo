// Copyright (c) Microsoft Corporation.  
// Licensed under the MIT license.

{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "displayName": {
            "type": "string",
            "defaultValue": "Deploy data collection rule for VM Insights Health"
        },
        "policyName": {
            "type": "string",
            "defaultValue": "dedc752b-b26f-5210-bd03-33a0abd7c3f5"
        }
    },
    "variables": {
        "name": "[parameters('policyName')]"
    },
    "resources": [
        {
            "type": "Microsoft.Authorization/policyDefinitions",
            "apiVersion": "2019-09-01",
            "name": "[variables('name')]",
            "properties": {
                "displayName": "[parameters('displayName')]",
                "policyType": "Custom",
                "mode": "All",
                "description": "The data collection rule enables all monitors for the virtual machines with the guest health extension.",
                "metadata": {
                    "version": "1.0.0",
                    "category": "Monitoring"
                },
                "parameters": {
                    "logAnalytics": {
                        "type": "String",
                        "metadata": {
                            "displayName": "Log Analytics workspace",
                            "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
                            "strongType": "omsWorkspace",
                            "assignPermissions": true
                        }
                    },
                    "HealthDataCollectionRuleName": {
                        "type": "string",
                        "metadata": {
                            "description": "Specifies the name of the data collection rule to create."
                        },
                        "defaultValue": "Microsoft-VMInsights-Health"
                    }
                },
                "policyRule": {
                    "if": {
                        "allOf": [
                            {
                                "field": "type",
                                "equals": "Microsoft.OperationalInsights/workspaces"
                            }
                        ]
                    },
                    "then": {
                        "effect": "deployIfNotExists",
                        "details": {
                            "type": "Microsoft.Insights/dataCollectionRules",
                            "name": "Microsoft-VMInsights-Health",
                            "roleDefinitionIds": [
                                "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
                            ],
                            "deployment": {
                                "properties": {
                                    "mode": "incremental",
                                    "template": {
                                        "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                        "contentVersion": "1.0.0.0",
                                        "parameters": {
                                            "defaultHealthDataCollectionRuleName": {
                                                "type": "string",
                                                "metadata": {
                                                    "description": "Specifies the name of the data collection rule to create."
                                                },
                                                "defaultValue": "Microsoft-VMInsights-Health"
                                            },
                                            "destinationWorkspaceResourceId": {
                                                "type": "string",
                                                "metadata": {
                                                    "description": "Specifies the Azure resource ID of the Log Analytics workspace to use to store virtual machine health data."
                                                }
                                            },
                                            "dataCollectionRuleLocation": {
                                                "type": "string",
                                                "metadata": {
                                                    "description": "The location code in which the data collection rule should be deployed. Examples: eastus, westeurope, etc"
                                                }
                                            }
                                        },
                                        "resources": [
                                            {
                                                "type": "Microsoft.Insights/dataCollectionRules",
                                                "name": "[[parameters('defaultHealthDataCollectionRuleName')]",
                                                "location": "[[parameters('dataCollectionRuleLocation')]",
                                                "apiVersion": "2019-11-01-preview",
                                                "properties": {
                                                    "description": "Data collection rule for VM Insights health.",
                                                    "dataSources": {
                                                    "performanceCounters": [
                                                        {
                                                            "name": "VMHealthPerfCounters",
                                                            "streams": [ "Microsoft-Perf" ],
                                                            "scheduledTransferPeriod": "PT1M",
                                                            "samplingFrequencyInSeconds": 60,
                                                            "counterSpecifiers": [
                                                                "\\LogicalDisk(*)\\% Free Space",
                                                                "\\Memory\\Available Bytes",
                                                                "\\Processor(_Total)\\% Processor Time"
                                                            ]
                                                        }
                                                    ],
                                                    "extensions": [
                                                        {
                                                            "name": "Microsoft-VMInsights-Health",
                                                            "streams": [
                                                                "Microsoft-HealthStateChange"
                                                            ],
                                                            "extensionName": "HealthExtension",
                                                            "extensionSettings": {
                                                                "schemaVersion": "1.0",
                                                                "healthRuleOverrides": [
                                                                    {
                                                                        "scopes": [ "*" ],
                                                                        "monitors": ["root"],
                                                                        "alertConfiguration": {
                                                                        "isEnabled": true
                                                                        }
                                                                    }
                                                                ]
                                                            },
                                                            "inputDataSources": [
                                                                "VMHealthPerfCounters"
                                                            ]
                                                        }
                                                    ]
                                                    },
                                                    "destinations": {
                                                        "logAnalytics": [
                                                            {
                                                                "workspaceResourceId": "[[parameters('destinationWorkspaceResourceId')]",
                                                                "name": "Microsoft-HealthStateChange-Dest"
                                                            }
                                                        ]
                                                    },					
                                                    "dataFlows": [
                                                        {
                                                            "streams": [
                                                                "Microsoft-HealthStateChange"
                                                            ],
                                                            "destinations": [
                                                                "Microsoft-HealthStateChange-Dest"
                                                            ]
                                                        }
                                                    ]
                                                }
                                            }
                                        ]
                                    },
                                    "parameters": {
                                        "defaultHealthDataCollectionRuleName": {
                                            "value": "[[parameters('HealthDataCollectionRuleName')]"
                                        },
                                        "destinationWorkspaceResourceId": {
                                            "value": "[[parameters('logAnalytics')]"
                                        },
                                        "dataCollectionRuleLocation": {
                                            "value": "[[field('location')]"
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    ]
  }